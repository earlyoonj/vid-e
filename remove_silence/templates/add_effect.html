{% extends 'layout.html' %}


{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/add_effect.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css">
{% endblock %}


<!-- header : video -->
{% block video %}
 <video id="input-video" src="{{ url_for('static', filename='temp/ptsd_lecture/ptsd_lecture.mp4') }}" width = "280" height = "160" controls></video>
{% endblock %}

<!-- header : control -->
{% block control %}
<button onclick="export_to_py('{{url_for('test',id=video.id)}}')" style="cursor:pointer">EXPORT</button>
{% endblock %}


{% block content %}
   
    <ol id="transcript-list">
        {% for sentence in keyword_sentences %}
            <li>
                <audio src=""></audio>
                <p>
                    {{sentence.text.prev}}
                    <strong class="keyword">{{sentence.text.keyword}}</strong>
                    {{sentence.text.next}}
                </p>
            </li>
        {% endfor %}
    </ol>

    <!-- 여기 -->
    <div id="effect-list">

        <div class="radio">
            <input type="radio" id="front" name="where" value="front" 
                   checked>
            <label for="front">앞</label>
        
            <input type="radio" id="back" name="where" value="back">
            <label for="back">뒤</label>
          </div>
        <p>효과음 라이브러리</p>
        <p>short effect</p>
        <div class="short">

            <h4>뾱</h4>
            <div id = "short_bbyok"></div>
           
            <script>
                var i = 1;
            </script>
            {% for file in short_effect[0][:] %}
                
                <script type="text/javascript">
                    document.write('<audio id='+"short_bbyok0"+i+'>');
                    document.write('<source src="{{ url_for('static', filename='sound-effect/'+file) }}" type="audio/mpeg">')
                    document.write('</audio>')
                    short_bbyok.innerHTML += `<button class="btn0${i}" onclick="play_short_bbyok0${i}()" style="cursor:pointer">뾱${i}</button>`
                    short_bbyok.innerHTML += `<button class="add 0${i}" onclick="add_effect_s0(${i})" style="cursor:pointer">with</button>`;
                    function play_short_bbyok01() {
                        var x = document.getElementById("short_bbyok01");
                        x.play();
                    }
                    function play_short_bbyok02() {
                        var x = document.getElementById("short_bbyok02");
                        x.play();
                    }
                    i++;

                    function add_effect_s0(idx){
                        if(idx == 1){
                            console.log("tttt");
                            var x = document.getElementById("short_bbyok01");
                            add_effect_a(0,x)
                        }
                        else{
                            var x = document.getElementById("short_bbyok02");
                            add_effect_a(1,x)
                        }
                    }
                </script>
            {% endfor %}

            <h4>띵</h4>
            <div id = "short_dding"></div>
            <script>
                var i = 1;
            </script>
            {% for file in short_effect[1][:] %}
                <script type="text/javascript">
                    document.write('<audio id='+"short_dding0"+i+'>');
                    document.write('<source src="{{ url_for('static', filename='sound-effect/'+file) }}" type="audio/mpeg">')
                    document.write('</audio>')
                    short_dding.innerHTML += `<button class="btn0${i}" onclick="play_short_dding0${i}()" style="cursor:pointer">띵${i}</button>`;
                    short_dding.innerHTML += `<button class="add 1${i}" onclick="add_effect_s1(${i}+2)" style="cursor:pointer">with</button>`;
                    function play_short_dding01() {
                        var x = document.getElementById("short_dding01");
                        x.play();
                    }
                    function play_short_dding02() {
                        var x = document.getElementById("short_dding02");
                        x.play();
                    }
                    i++;
                    function add_effect_s1(idx){
                        console.log("ddddd",idx);
                        if(idx == 3){
                            var x = document.getElementById("short_dding01");
                            add_effect_a(2,x)
                        }
                        else{
                            var x = document.getElementById("short_dding02");
                            add_effect_a(3,x)
                        }
                    }
                </script>
            {% endfor %}

            <h4>휙</h4>
            <div id = "short_swish"></div>
            <script>
                var i = 1;
            </script>
            {% for file in short_effect[2][:] %}
                <script type="text/javascript">
                    document.write('<audio id='+"short_swish0"+i+'>');
                    document.write('<source src="{{ url_for('static', filename='sound-effect/'+file) }}" type="audio/mpeg">')
                    document.write('</audio>')
                    short_swish.innerHTML += `<button class="btn0${i}" onclick="play_short_swish0${i}()" style="cursor:pointer">휙${i}</button>`;
                    short_swish.innerHTML += `<button class="add 2${i}" onclick="add_effect_s2(${i})" style="cursor:pointer">with</button>`;
                    function play_short_swish01() {
                        var x = document.getElementById("short_swish01");
                        x.play();
                    }
                    function play_short_swish02() {
                        var x = document.getElementById("short_swish02");
                        x.play();
                    }
                    i++;
                    function add_effect_s2(idx){
                        if(idx == 1){
                            var x = document.getElementById("short_swish01");
                            add_effect_a(4,x)
                        }
                        else{
                            var x = document.getElementById("short_swish02");
                            add_effect_a(5,x)
                        }
                    }
                </script>
            {% endfor %}

            <h4>별가루</h4>
            <div id = "short_star"></div>
            <script>
                var i = 1;
            </script>
            {% for file in short_effect[3][:] %}
                <script type="text/javascript">
                    document.write('<audio id='+"short_star0"+i+'>');
                    document.write('<source src="{{ url_for('static', filename='sound-effect/'+file) }}" type="audio/mpeg">')
                    document.write('</audio>')
                    short_star.innerHTML += `<button class="btn0${i}" onclick="play_short_star0${i}()" style="cursor:pointer">별${i}</button>`;
                    short_star.innerHTML += `<button class="add 3${i}" onclick="add_effect_s3(${i})" style="cursor:pointer">with</button>`;
                    function play_short_star01() {
                        var x = document.getElementById("short_star01");
                        x.play();
                    }
                    function play_short_star02() {
                        var x = document.getElementById("short_star02");
                        x.play();
                    }
                    i++;
                    function add_effect_s3(idx){
                        if(idx == 1){
                            var x = document.getElementById("short_star01");
                            add_effect_a(6,x)
                        }
                        else{
                            var x = document.getElementById("short_star02");
                            add_effect_a(7,x)
                        }
                    }
                </script>
            {% endfor %}
        </div>

        <p>long effect</p>
        <div class="long">

            <h4>뾰롱</h4>
            <div id = "long_bbyorong"></div>
            <script>
                var i = 1;
            </script>
            {% for file in long_effect[0][:] %}
                <script type="text/javascript">
                    document.write('<audio id='+"long_bbyorong0"+i+'>');
                    document.write('<source src="{{ url_for('static', filename='sound-effect/'+file) }}" type="audio/mpeg">')
                    document.write('</audio>')
                    long_bbyorong.innerHTML += `<button class="btn0${i}" onclick="play_long_bbyorong0${i}()" style="cursor:pointer">뾰롱${i}</button>`;
                    long_bbyorong.innerHTML += `<button class="add 0${i}" onclick="add_effect_l0(${i})" style="cursor:pointer">with</button>`;
                    function play_long_bbyorong01() {
                        var x = document.getElementById("long_bbyorong01");
                        x.play();
                    }
                    function play_long_bbyorong02() {
                        var x = document.getElementById("long_bbyorong02");
                        x.play();
                    }
                    i++;
                    function add_effect_l0(idx){
                        if(idx == 1){
                            var x = document.getElementById("long_bbyorong01");
                            add_effect_a(8,x)
                        }
                        else{
                            var x = document.getElementById("long_bbyorong02");
                            add_effect_a(9,x)
                        }
                    }
                </script>
            {% endfor %}

            <h4>띠링</h4>
            <div id = "long_ddiring"></div>
            <script>
                var i = 1;
            </script>
            {% for file in long_effect[1][:] %}
                <script type="text/javascript">
                    document.write('<audio id='+"long_ddiring0"+i+'>');
                    document.write('<source src="{{ url_for('static', filename='sound-effect/'+file) }}" type="audio/mpeg">')
                    document.write('</audio>')
                    long_ddiring.innerHTML += `<button class="btn0${i}" onclick="play_long_ddiring0${i}()" style="cursor:pointer">띠링${i}</button>`;
                    long_ddiring.innerHTML += `<button class="add 1${i}" onclick="add_effect_l1(${i})" style="cursor:pointer">with</button>`;
                    function play_long_ddiring01() {
                        var x = document.getElementById("long_ddiring01");
                        x.play();
                    }
                    function play_long_ddiring02() {
                        var x = document.getElementById("long_ddiring02");
                        x.play();
                    }
                    i++;
                    function add_effect_l1(idx){
                        if(idx == 1){
                            var x = document.getElementById("long_ddiring01");
                            add_effect_a(10,x)
                        }
                        else{
                            var x = document.getElementById("long_ddiring02");
                            add_effect_a(11,x)
                        }
                    }
                </script>
            {% endfor %}

            <h4>휘익</h4>
            <div id = "long_swish"></div>
            <script>
                var i = 1;
            </script>
            {% for file in long_effect[2][:] %}
                <script type="text/javascript">
                    document.write('<audio id='+"long_swish0"+i+'>');
                    document.write('<source src="{{ url_for('static', filename='sound-effect/'+file) }}" type="audio/mpeg">')
                    document.write('</audio>')
                    long_swish.innerHTML += `<button class="btn0${i}" onclick="play_long_swish0${i}()" style="cursor:pointer">휘익${i}</button>`;
                    long_swish.innerHTML += `<button class="add 2${i}" onclick="add_effect_l2(${i})" style="cursor:pointer">with</button>`;
                    function play_long_swish01() {
                        var x = document.getElementById("long_swish01");
                        x.play();
                    }
                    function play_long_swish02() {
                        var x = document.getElementById("long_swish02");
                        x.play();
                    }
                    i++;
                    function add_effect_l2(idx){
                        if(idx == 1){
                            var x = document.getElementById("long_swish01");
                            add_effect_a(12,x)
                        }
                        else{
                            var x = document.getElementById("long_swish02");
                            add_effect_a(13,x)
                        }
                    }
                </script>
            {% endfor %}

            <h4>별가루</h4>
            <div id = "long_star"></div>
            <script>
                var i = 1;
            </script>
            {% for file in long_effect[3][:] %}
                <script type="text/javascript">
                    document.write('<audio id='+"long_star0"+i+'>');
                    document.write('<source src="{{ url_for('static', filename='sound-effect/'+file) }}" type="audio/mpeg">')
                    document.write('</audio>')
                    long_star.innerHTML += `<button class="btn0${i}" onclick="play_long_star0${i}()" style="cursor:pointer">별가루${i}</button>`;
                    long_star.innerHTML += `<button class="add 3${i}" onclick="add_effect_l3(${i})" style="cursor:pointer">with</button>`;
                    function play_long_star01() {
                        var x = document.getElementById("long_star01");
                        x.play();
                    }
                    function play_long_star02() {
                        var x = document.getElementById("long_star02");
                        x.play();
                    }
                    i++;
                    function add_effect_l3(idx){
                        if(idx == 1){
                            var x = document.getElementById("long_star01");
                            add_effect_a(14,x)
                        }
                        else{
                            var x = document.getElementById("long_star02");
                            add_effect_a(15,x)
                        }
                    }
                </script>
            {% endfor %}
        </div>
    </div>

    <!-- <div id="add-effect-control">
        <ol id="transcript-list">
            {% for sentence in keyword_sentences %}
                <li>
                    <audio src=""></audio>
                    <p>
                        {{sentence.text.prev}}
                        <strong class="keyword">{{sentence.text.keyword}}</strong>
                        {{sentence.text.next}}
                    </p>
                </li>
            {% endfor %}
        </ol>
        <div id="effect-list"></div>
    </div> -->

{% endblock %} 

{% block js %}

     <script>

         $(window).scroll(function(){
        var scrollTop = $(document).scrollTop();
        if (scrollTop < 10) {
        scrollTop = 10;
        }
        $("#effect-list").stop();
        $("#effect-list").animate( { "top" : scrollTop });
        });

        const sentences = JSON.parse('{{keyword_sentences | tojson}}');
        const ori = document.querySelector("#input-video");

        const select_audio = ['짧은_뿅_01.mp3', '짧은_뿅_02.mp3', 
                            '짧은_띵_01.mp3', '짧은_띵_02.mp3', 
                            '짧은_휙_01.mp3', '짧은_휙_02.mp3', 
                            '짧은_별가루_01.mp3', '짧은_별가루_02.mp3',
                            '긴_뾰롱_01.mp3', '긴_뾰롱_02.mp3', 
                            '긴_띠링_01.mp3', '긴_띠링_02.mp3', 
                            '긴_휙_01.mp3', '긴_휙_02.mp3', 
                            '긴_별가루_01.mp3', '긴_별가루_02.mp3']
                    
        var export_audio_list = new Array(sentences.length);
        var effect_start = [];
        
        function export_list(present_idx,eidx){
            export_audio_list[present_idx] = select_audio[eidx];
            console.log("여기에",present_idx,"이거추가할거임",eidx);
            return export_audio_list;
        };

       // const btn = document.querySelector(".btn1");
        //클릭한 리스트의 문장시작, 키워드시작, 키워드끝나는 시간 받아오기


        $("li").click(function(){
            var idx = $("li").index(this);
            present_idx = get_index(idx);
            console.log(present_idx);
            time_info = time_process(present_idx);
         });  

        function get_index(idx){
        return idx;
        };

        function time_process(idx){
            //인덱스 별로 시간들 가져와서 변수에 할당
            var senten_start = sentences[idx]['time']['sentence']['start'];
            var senten_end = sentences[idx]['time']['sentence']['end'];
            var keyword_start = sentences[idx]['time']['keyword']['start'];
            var keyword_end = sentences[idx]['time']['keyword']['end'];
            
            var effect_time_f = keyword_start - senten_start;
            var effect_time_b = keyword_end - senten_start;
            console.log(senten_start,senten_end);
            //여러 값 리턴해주기
            return {keyword_start : keyword_start,
                    keyword_end : keyword_end,
                    effect_time_f : effect_time_f,
                    effect_time_b : effect_time_b,
                    senten_start : senten_start,
                    senten_end : senten_end
            };
        };


        function to_get_time_list(op_where, time_info){
            if (op_where == 'front'){
                //console.log("d")
            return { effect_time : time_info.effect_time_f,
                    export_time : time_info.keyword_start
                };
        }
            else{
                return {effect_time : time_info.effect_time_b,
                        export_time : time_info.keyword_end
                };
            }
    };
        function add_effect_a(eidx,effect_audio){
            a = export_list(present_idx,eidx);
            //console.log(a);
            time_info = time_process(present_idx);
            //앞, 뒤 중 선택한 값 할당
            var op_where= $('input:radio[name="where"]:checked').val();
            var duaration_time = time_info.senten_end- time_info.senten_start;
            console.log(duaration_time);
            console.log("앞뒤",op_where);
            var offset = to_get_time_list(op_where, time_info)
            var offset_time = offset.effect_time;
            //var effect_audio = x;
            console.log(effect_audio);
            console.log("오디오인덱스",eidx);
            console.log(offset);
            //ㅂㄷㅂㄷ 밀리세컨드로 받는게 아니라 그냥 초로 받는거였음 ㅂㄷㅂㄷㅂㄷ
            ori.currentTime = time_info.senten_start/1000; 
            console.log("언제시작해?",time_info.senten_start);
            ori.play();
            var first_play = setTimeout(function () { 
                //console.log("효과음언제나와",offset_time);
                effect_audio.play();
                }, offset_time);
        };


        const postjson = (url) =>  {
            fetch(url, {
            method: 'POST', 
            headers:{
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                    'audio_list' : export_audio_list,
                    'audio_time' : effect_start

            })
            }).then(res => res.json())
            .then(response => console.log('Success:', JSON.stringify(response)))
        }
        
        function export_to_py(url){   
            var op_where= $('input:radio[name="where"]:checked').val();
            //오디오가 추가된 index만 가져오기 위해
            var index_true = [];
            for(var i=0; i<export_audio_list.length; i++) {
                if (export_audio_list[i]){
                    index_true.push(i);
                }
            }

            for (var idx of index_true) { 
                if (op_where == 'front'){
                    effect_start.push(sentences[idx]['time']['keyword']['start']);}
                else{
                    effect_start.push(sentences[idx]['time']['keyword']['end']);
                }
            }
            console.log(effect_start,"이거되나");

            //오디오 추가 안누른 나머지 empty 값 없애고 순서대로 오디오리스트 남김
            export_audio_list = export_audio_list.filter(function(item) {
                return item !== null && item !== undefined && item !== '';
                });
            console.log(export_audio_list);

            postjson(url);
        };


    </script>

{% endblock %}